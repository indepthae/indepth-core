<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
<script src ="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.0.2/jszip-utils.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
<div id="content-header">
    <%= show_header_icon %>
    <h1><%= t('gallery') %></h1>
    <div class='header-sep'>|</div>
    <div class='sub-header'><%= t('galleries.images') %></div>

    <div id="inner-tab-menu">
        <ul>
            <% if @total_images_count > 0 %><li class='themed_bg themed-dark-hover-background' style="height: 25px;line-height: 24px;width: 120px! important;cursor:pointer;" onclick="download_album();"><%=  t('galleries.Download_Album')%></li><% end %>
            <%  if permitted_to? :add_photo,:galleries %>
              <% if @photos.count != 0 %>
                <li class='themed_bg themed-dark-hover-background'><%= link_to t('add_images'), :action=>"add_photo", :id=>@category.id %> </li>
              <%end%>
            <% end %>
            <%  if permitted_to? :category_edit,:galleries %>
              <li class='themed_bg themed-dark-hover-background'><%= link_to t('editt'), :action=>"category_edit", :id=>@category.id %> </li>
            <% end %>
            <%  if ((permitted_to? :set_publish,:galleries) and @photos.count!=0)  %>
              <li class='themed_bg themed-dark-hover-background'> <a id="publish_button" onclick="confirm_publish()" href="#"><%= @button_value  %></a> </li>
            <% end %>
            <%  if ((permitted_to? :more_option,:galleries))  %>
              <li id="drop_header" class='themed_bg themed-dark-hover-background'>
                  <a href="#" id="drop_header_link"><%= t('more') %> &#9660;</a>
                  <ul id="box_1" class="more-menu-div" style="display: none;">
                      <%  if permitted_to? :category_delete,:galleries %>
                        <li class='themed_bg themed-dark-hover-background'><a href="#" onclick="delete_album_pressed()"><%=t('delete_album') %> </a></li>
                      <% end %>

                      <%  if ((permitted_to? :more_option,:galleries) and @photos.count!=0)  %>
                        <li class='themed_bg themed-dark-hover-background'><%= link_to t('delete_images') , {:action=>"more_option", :id=>@category.id} %> </li>
                      <% end %>
                  </ul>
              </li>
            <% end %>
        </ul>
    </div>
</div>
<div id="page-yield">
    <div class="bread_crumb">
        <%breadcrumb :galleries_category_show,@category%>
        <%=render_breadcrumbs%>
    </div>

    <div id="loading_overlay" class="loading_overlay">
        <div class="loading_overlay_text"><%=t('galleries.deleting_image')%></div>
    </div>

    <% unless flash[:notice].nil? %>
      <p class="flash-msg"> <%= flash[:notice]  %> </p>
    <% end %>

    <div class="show_photo" onclick="carousel_outside_click(event)" id="show_photo">
        <div class="inner_box">
            <div class="image_box">
                <div class="upper_panel">
                    <div class="full_description" id="full_description">
                         <div id="description_region" style="width:1315px;float:left;"></div>
                         <a id ="image_download"><div class="btn_download btn_download_bg_hover" > Download<div id ="download_icon" ></div></div></a>
                    </div>

                    <div class="close_photo" onclick="close_image()"></div>
                </div>
                <div class="full_image" id="full_image">
                </div>
                <div class="controls">
                    <div class="previous">
                        <button class="control" id="previous" ><div class="image_previous"></div><div class="previous_text"><%=t('galleries.carousel_previous')%></div></button>
                    </div>
                    <div class="current_image" id="current_image">

                    </div>
                    <div class="next">
                        <button class="control" id="next" ><div class="next_text"><%=t('galleries.carousel_next')%></div><div class="image_next"></div></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="album_photos">
        <div class="head">
            <%= @category.name%>
        </div>
        <div class="line"></div>
        <div class="album_status">
            <div class="photo_count elements">
                <%=t('galleries.images_collen')%><b> <span id="photos_count"><%= @total_images_count %></span></b>
            </div>
            <div class="visibility elements">
                <% if @admin_mode %>
                  <%=t('galleries.visibility')%> <b><%=@visibility_tag%></b>
                <%end%>
            </div>
            <div class="status elements">
                <% if @admin_mode %>
                  <%=t('galleries.status')%><b> <span id="published_status"><%= @category.published ? t('galleries.published_status_active') : t('galleries.published_status_unpublished') %></span></b>
                <%end%>
            </div>
            <div id="published_on" class="published_on elements">
                <%= @category.published? ? t('galleries.published_on') : t('galleries.created_on')%><b> <%= @category.published? ? format_date(@category.published_date) : format_date(@category.created_at.to_date) %></b>
            </div>
        </div>



        <div id="album_images" class="album_images">
            <% @photos.each_with_index do |image,index| %>
              <% index= index+1%>

              <%= '<div class="row">' if ((index+2)%3) == 0  %>


              <div class="album_photo <%= (index+1)%3 == 0 ? " photo_middle" : "" %>" style="background-image: url('<%=  image.photo.url(:thumb, false)%>');" data-value='<%=(index-1)+@offset%>'>
                  <div class="photo_extra">
                      <div id=<%="desc"+image.id.to_s %> class="photo_description <%= @admin_mode ? "" : "full_width" %>"> <%= (image.description.nil?) ? "" : image.description %></div>
                      <%if @admin_mode%>
                        <div class="photo_options">
                            <div class="dropdown">
                                <button disabled class="dropbtn"><%=t('galleries.editt')%></button>
                                <div class="dropdown-content">
                                    <a href="#" class="edit_link" data-value= <%=image.id %> data-index= <%=index-1%> id="img_edit_desc"><%=t('galleries.edit_description')%></a>
                                    <a href="#" class="delete_link" data-value= <%=image.id %>  data-index= <%=index-1%> ><%=t('galleries.delete')%></a>
                                </div>
                            </div>
                        </div>
                      <%end%>
                  </div>
              </div>



              <% #row %>
              <%= '</div>'if (index%3) == 0%>

            <% end %>
            <% #In case row doesnt get closed - In last case where no of photos is less than 3 %>
            <%= '</div>'if (@photos.count%3) != 0%>
            <%= will_paginate @photos,:params=>{:controller => "galleries",:action => "category_show", :id=> @category.id},:remote=>{:update=>'album_images'}%>
        </div>

    </div>

    <%if @photos.count==0%>
      <div class="add_photo_box">
          <div class="box_center">
              <center>
                  <div class="box_head">
                      <%=t('galleries.start_adding_photos')%>
                  </div>
                  <div class="box_button">
                      <%= link_to t('add_images'), {:action=>"add_photo", :id=>@category.id },:class=>"plain_button"%>
                  </div>

              </center>
          </div>
      </div>
    <%end%>

</div>
<script>
  
  j(document).ready(function () {
      j("#drop_header").hover(
              function () {
                  link_off = j("#drop_header").offset();
                  link_width = j("#drop_header").width();
                  link_height = j("#drop_header").height();
                  box_width = j("#box_1").width();
                  //  c_b.css({ top: (0 - (child_bottom - main_bottom))});
                  j("#box_1").css({top: (link_off.top + link_height), left: ((link_off.left + link_width) - box_width)});
                  j("#box_1").css("display", "block");
              },
              function () {
                  j("#box_1").css("display", "none");
              });
  });
  var current_visibility_state = <%=@category.visibility %>;
  var current_publish_state = <%= @category.published %>;
  var gallery_category_id = <%= @category.id %>;
  var offset = <%= @offset.to_json %>;
  var data;
  function download_album() {
      var count = 0;
      var gallery_category = "<%=  @category.id%>"
      var total_images = (url_array.length);
      document.body.scrollTop = document.documentElement.scrollTop = 0;
      build_modal_box({'title': "<%=t('galleries.downloading_images')%>", 'popup_class': 'confirmation'});
      j('#popup_content').append('<div class="progress_container"><div class="progress" id="progress"><div class="bar" id="bar"></div></div><div id="upload_status" class="upload_status"><%=t('galleries.downloading')%> 1 <%=t('galleries.out_of')%> ' + total_images + '</div></div>');
      j("#upload_status").html("<%=t('galleries.downloading')%> 1 <%=t('galleries.out_of')%> " + total_images);
      document.body.style.overflow = "hidden";
      var zip = new JSZip();
      var zipFilename = '<%= @category.name %>';
      var img_folder = zip.folder('<%= @category.name%>')
      url_array.forEach(function (url, i) {
          var filename = url[1];
          j.ajax({
              type: "POST",
              success: function (msg) {
                  
                  JSZipUtils.getBinaryContent(url[0], function (err, data) {
                      if (err) {
                          throw err; // or handle the error
                      }
                      var upload_count = count+1 ;
                      j("#upload_status").html("<%=t('galleries.downloading')%> " + (upload_count > total_images ? total_images : upload_count) + " <%=t('galleries.out_of')%> " + total_images);
                      var width = ((upload_count) / total_images) * 100;
                      j("#bar").width(width + '%');
                      img_folder.file(filename, data, {binary: true});
                      count++;
                      if (count == url_array.length) {
                          zip.generateAsync({type: 'blob'}).then(function (content) {
                              saveAs(content, zipFilename);
                              document.body.style.overflow = "auto";
                              window.location.replace("/galleries/category_show/" + gallery_category);
                          });
                      }
                  });
              }
          });
      });
  }

  function confirm_publish() {
      if (current_visibility_state) {
          make_popup_box(this, 'confirm', (current_publish_state
                  ? "<%=t('galleries.unpublish_confirmation')%>"
                  : "<%=t('galleries.publish_public_confirmation')%>"), {
              'ok': (current_publish_state
                      ? "<%=t('galleries.unpublish_album')%>"
                      : "<%=t('galleries.publish_album')%>"),
              'cancel': "<%=t('galleries.cancel')%>",
              'title': (current_publish_state
                      ? "<%=t('galleries.unpublish_album')%>"
                      : "<%=t('galleries.publish_album')%>"),
              'popup_class': 'remove_lt',
              'return_status': true
          });
          return publish_confirmed();
      } else {
          make_popup_box(this, 'confirm', (current_publish_state
                  ? "<%=t('galleries.unpublish_confirmation')%>"
                  : "<%=t('galleries.publish_private_confirmation')%>"), {
              'ok': (current_publish_state
                      ? "<%=t('galleries.unpublish_album')%>"
                      : "<%=t('galleries.publish_album')%>"),
              'cancel': "<%=t('galleries.cancel')%>",
              'title': (current_publish_state
                      ? "<%=t('galleries.unpublish_album')%>"
                      : "<%=t('galleries.publish_album')%>"),
              'popup_class': 'remove_lt',
              'return_status': true
          });
          return publish_confirmed();
      }


  }

  function publish_confirmed() {
      j('#yes').click(function () {
          set_publish();
          remove_popup_box();
      });
  }

  //publish - unpublish

  function set_publish() {
      var category_id = <%=@category.id%>;
      j.ajax({
          type: "POST",
          data: {
              "id": category_id,
              "session_fingerprint": "<%=session_fingerprint%>"
          },
          url: "/galleries/set_publish",
          success: function (msg) {
              var value = msg;
              if (value["set_success"] == true) {
                  j("#publish_button").html(value["button_value"]);
                  j("#published_status").html(value["state"]);
                  j("#published_on").html(value["published_on"]);
                  current_publish_state = value["publish_status"];
              } else {
                  console.log(value["message"]);
              }
              console.log(msg)
          }
      });
  }

  function carousel_outside_click(e) {
      if (j(e.target).closest(".image_box").length > 0) {
          //click on carousel .. do nothing
      } else {
          close_image();
      }

  }

  // carousel open or not
  var carousel_state = false;

  //holds current image
  var activeimg = 0;
  var url_array = <%= raw @original_images_url.to_json %>;
  var description_array = <%= raw @image_description.to_json %>;

  set_delete_action();
  set_edit_description();
  set_image_carousel();

  function confirmation_delete(element) {
      j('#yes').click(function () {
          j("#loading_overlay").css("display", "block");
          j.ajax({
              type: "POST",
              data: {
                  "id": j(element).data("value"), "page":<%= raw (params[:page]==nil ?  "1" : params[:page]).to_json%>, "session_fingerprint": "<%=session_fingerprint%>"
              },
              url: "/galleries/photo_delete",
              success: function (msg) {
                  j("#loading_overlay").css("display", "none");
                  var index = j(element).data("index");
                  set_delete_action();
                  set_edit_description();
                  set_image_carousel();
              }
          });
          remove_popup_box();
      });

  }

  function confirmation_edit(element) {
      j("#prompt_value").attr("maxlength", 220);
      j('#yes').click(function () {
          j.ajax({
              type: "POST",
              data: {
                  "id": j(element).data("value"),
                  "description": j("#prompt_value").val(),
                  "session_fingerprint": "<%=session_fingerprint%>"
              },
              url: "/galleries/edit_photo_description",
              success: function (msg) {
                  console.log(msg);
                  var value = msg;
                  if (value["status"] == true) {
                      //set description
                      j("#desc" + j(element).data("value")).html(value["description"]);
                      var index = j(element).data("index");
                      description_array[index] = value["description"];
                      remove_popup_box();
                  } else {
                  }

              }
          });
      });
  }

  function set_delete_action() {
      j(".delete_link").click(function (e) {
          e.stopPropagation();
          console.log("delete clicked");
          make_popup_box(this, 'confirm', "<%=t('galleries.photo_delete_description')%>", {
              'ok': "<%=t('galleries.delete_photo')%>",
              'cancel': "<%=t('galleries.cancel')%>",
              'title': "<%=t('galleries.delete_photo')%>",
              'popup_class': 'remove_lt',
              'return_status': true
          });
          return confirmation_delete(this);

      });
  }

  function set_edit_description() {
      j(".edit_link").click(function (e) {
          e.stopPropagation();
          console.log("edit clicked");

          make_popup_box(this, 'prompt', "<%=t('galleries.description')%>", {
              'submit': "<%=t('galleries.save')%>",
              'cancel': 'Cancel',
              'title': "<%=t('galleries.edit_photo')%>",
              'popup_class': 'remove_lt',
              'return_status': true,
              'input_type': "textarea"
          });

          j("#prompt_value").val(description_array[j(this).data("index")]);
          return confirmation_edit(this);

      });
  }


  function delete_album_pressed() {
      console.log("delete pressed");
      make_popup_box(this, 'confirm', "<%=t('galleries.delete_album_text')%>", {
          'ok': "<%=t('galleries.delete_album')%>",
          'cancel': "<%=t('galleries.cancel')%>",
          'title': "<%=t('galleries.delete_album')%>",
          'popup_class': 'remove_lt',
          'return_status': true
      });
      return confirmation_album_delete(this);


  }

  function confirmation_album_delete() {
      j('#yes').click(function () {
          window.location.replace("/galleries/category_delete/" + gallery_category_id);
      });

  }

  j(document).keydown(function (e) {
      if (carousel_state == true) {
          switch (e.which) {
              case 37: // left
                  previous();
                  break;

              case 38: // up
                  break;

              case 39: // right
                  next();
                  break;

              case 40: // down
                  break;

              case 27: //escape button
                  close_image();
                  break;

              default:
                  return; // exit this handler for other keys
          }
      }

  });

  function display_image(id) {
      carousel_state = true;
      id = parseInt(id);
      j(document.body).addClass("lock_scroll");
      j("#show_photo").css("display", "block");
      activeimg = id;
      if (url_array.length > 1) {
          j("#previous").css("display", "inline-block");
          j("#next").css("display", "inline-block");
      } else {
          j("#previous").css("display", "none");
          j("#next").css("display", "none");
      }
      setimage();
  }

  function set_image_carousel() {
      j(".album_photo").click(function () {
          display_image(j(this).data("value"));
      });
  }

  function setimage() {
      //this function sets image and its description
      var image = new Image();
      image_url = url_array[activeimg];
      image.src = image_url[0];
      document.getElementById("full_image").style.backgroundImage = "url('" + image.src + "')";
      j("#current_image").html("<%=t('galleries.carousel_showing')%> <b>" + (activeimg + 1) + "</b> out of <b>" + url_array.length + "</b>");
      j("#description_region").html(description_array[activeimg]);
      toDataUrl(image.src, function (myBase64) {
          j('#image_download').attr('href', myBase64); // myBase64 is the base64 string
      });
      j('#image_download').attr('download', image_url[1]);
  }

  function toDataUrl(url, callback) {
      var xhr = new XMLHttpRequest();
      xhr.onload = function () {
          var reader = new FileReader();
          reader.onloadend = function () {
              callback(reader.result);
          }
          reader.readAsDataURL(xhr.response);
      };
      xhr.open('GET', url);
      xhr.responseType = 'blob';
      xhr.send();
  }

  function close_image() {
      carousel_state = false;
      j(document.body).removeClass("lock_scroll");
      j("#show_photo").css("display", "none");
  }
  function previous() {
      if (activeimg == 0) {
          activeimg = (url_array.length - 1);
      } else {
          activeimg = activeimg - 1;
      }

      setimage();
  }
  //previous
  j("#previous").click(function () {
      previous();
  });
  function next() {
      if (activeimg == (url_array.length - 1)) {
          activeimg = 0;
      } else {
          activeimg = activeimg + 1;
      }
      setimage();
  }
  j("#next").click(function () {
      next();
  });
</script>
